{% extends "base.html" %}

{% set title = room.name %}

{% block content %}
    <div> <!-- Шапка комнаты -->
        <span class='name-large'>{{ room.name }}</span>
    </div>
    <div class='inline-flex-container space-between'>
        <div class='wroom-clmn wroom-clmn-fixed' style='min-width: 200px'> <!-- Список с игроками -->
            <span class='name-medium'>Игроки</span>
            <div id='players_list'></div>
        </div>
        <div class='wroom-clmn wroom-clmn-fixed' style='min-width: 300px'>
            <span class='name-medium'>Карта</span>
            <div>
                <br>
                <div style='width: 100px;height: 100px; border-color: grey; border: 1px solid grey; background: var(--clr-m1-l)'>
                    <img> 
                </div>
                <p class='text-font' style='text-align: justify;'>
                    Описание карты. Lorem Ipsum - это текст-"рыба", часто используемый в печати и вэб-дизайне. Lorem Ipsum является стандартной "рыбой" для текстов на латинице с начала XVI века. В то время некий безымянный печатник создал большую коллекцию размеров и форм шрифтов, используя Lorem Ipsum для распечатки образцов.
                </p>
            </div>
        </div>
        <div class='wroom-clmn wroom-clmn-grow'>
            <span class='name-medium'>Чат</span>
            <div class='wroom-chat-msgs scrollbar'>
                {% for i in range(10) %}
                <div class='inline-flex-container'>
                    <a href="{{ url_for('my_profile') }}"><img class='user-ava-small' src='{{ user_ava }}'></a>
                    <div class='wroom-chat-info'>
                        <span class='name-medium clr-m1'>{{ username }}</span>
                        <span class='time'>13:{{ 44+i}}</span>
                        <p>
Lorem Ipsum - это текст-"рыба", часто используемый в печати и вэб-дизайне. Lorem Ipsum является стандартной "рыбой" для текстов на латинице с начала XVI века. В то время некий безымянный печатник создал большую коллекцию размеров и форм шрифтов, используя Lorem Ipsum для распечатки образцов.
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div>
                <div contenteditable class='chat-input scrollbar' 
                data-placeholder='Введите сообщение' id='chat-input'></div>
            </div>
        </div>
    </div>
{% endblock %}

{% set show_sidebar_r = true %}
{% set ub__hide_play_button = true %}
{% block sidebar_content %}
    <form action="javascript:void(0);">
        {% if username == room.creator %}
            <button class='btn' id='start_game'>Начать</button>
        {% endif %}
        <button class='btn'>Пригласить</button>
        <button class='btn' id='exit_room'>Выйти</button>
        {# {% if username == room.creator %}
            <button class="btn" id="settings_button">Настройки</button>
        {% endif %} #}
    </form>
{% endblock %}

{% block scripts %}
    <script type='text/javascript'>
        $('#editor').on('paste', function(e) {
             e.preventDefault();
             
             if( e.originalEvent.clipboardData ) {
                  var content = e.originalEvent.clipboardData.getData('text/plain').replace(/\r\n|\r|\n/g, '');
                  console.log('pasted content only text', content);
                  document.execCommand('insertText', false, content);
            }
        });
    </script>
    <script type='text/javascript'>
        function xhrOpen(eventType) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', "{{ url_for('waiting_room', room_id=room.id) }}");
            xhr.setRequestHeader('Event-Type', eventType);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            return xhr;
        };

        function xhrGetTemplate(templateName) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', "{{ url_for('get_template', template_name='') }}" + templateName);
            return xhr;
        }

        function saveSettings() {
            var xhr = xhrOpen('change_settings');
            var description = document.getElementById('room_description').value;
            var name = document.getElementById('room_name').value;
            var mapId = document.getElementById('room_map').value;
            xhr.send('description='+description+'&name='+name+'&map_id='+mapId)
        }  

        $(document).ready(function () {
            userBlockTemplateLoader = xhrGetTemplate('_user_block-small.html');
            userBlockTemplateLoader.send();
            userBlockTemplateLoader.onload = function() {
                userBlockTemplate = userBlockTemplateLoader.responseText;
            };

            var socket = io.connect('http://' + document.domain + ':' + location.port + '/' + '{{ room.id }}');
            socket.on('update', function(msg) {
                switch (msg.event) {
                    case 'change_settings':
                        $('#title').html(msg.name);
                        $('#description').html('Описание:<br>' + msg.description.replace(/\n/g, '<br>'));
                        $('#map_name').html('Карта:' + msg.map.name);
                        $('#map_description').html('Описание карты:<br>' + msg.map.description.replace(/\n/g, '<br>'));
                        break;

                    case 'player_enter_or_leave':
                        $('#players_list').html(msg.data);
                        break;

                    case 'change_description':
                        $('#description').html('Description:<br>' + msg.description.replace(/\n/g, '<br>'));
                        break;

                    case 'delete_room':
                        alert('Oups. Room was deleted');
                        document.location.href = "{{ url_for('room_list') }}";
                        break;

                    case 'start_game':
                        document.location.href = "{{ url_for('game_room', room_id=room.id) }}";
                        break;
                };
            });
            window.onbeforeunload = function() {
                socket.emit('disconnect_request')
            };
        })

        $('#start_game').click(function(){
            var xhr = xhrOpen('start_game');
            xhr.send();
        })
        $('#exit_room').click(function(){
            window.location = "{{ url_for('room_list') }}"
        })
        $('#delete_aroom').click(function(){
            var xhr = xhrOpen('delete_room');
            xhr.send();
        })


        // var settingButton = document.getElementById('settings_button');
        // var roomInfo = document.getElementById('room_info');
        // var roomSettings = document.getElementById('room_settings');
        // if (settingButton) {
        //     settingButton.onclick = function() {
        //         toggle(roomInfo);
        //         toggle(roomSettings);
        //     };
        // };
    </script>
{% endblock %}
